# 完整使用指南

本指南将帮助你从零开始使用这个飞书文档筛选条件获取插件。

## 📋 目录

1. [环境要求](#环境要求)
2. [快速开始](#快速开始)
3. [详细配置步骤](#详细配置步骤)
4. [本地开发](#本地开发)
5. [部署到生产环境](#部署到生产环境)
6. [在飞书中使用](#在飞书中使用)
7. [故障排查](#故障排查)

---

## 环境要求

### 必需软件

- **Node.js**: 版本 18.0 或更高
- **npm**: 版本 9.0 或更高（或使用 yarn/pnpm）
- **Git**: 用于版本控制（可选）

### 检查环境

打开终端，运行以下命令检查：

```bash
# 检查 Node.js 版本
node --version
# 应该显示 v18.x.x 或更高

# 检查 npm 版本
npm --version
# 应该显示 9.x.x 或更高
```

如果未安装，请访问：
- [Node.js 官网](https://nodejs.org/) 下载安装

---

## 快速开始

### 步骤 1: 克隆或下载项目

如果你有 Git：

```bash
git clone <项目地址>
cd feishu-plugin
```

或者直接下载项目 ZIP 文件并解压。

### 步骤 2: 安装依赖

在项目根目录运行：

```bash
npm install
```

这将会安装所有必需的依赖包，可能需要几分钟时间。

### 步骤 3: 启动开发服务器

```bash
npm run dev
```

看到以下输出表示成功：

```
  ▲ Next.js 13.x.x
  - Local:        http://localhost:3000
  - ready started server on 0.0.0.0:3000
```

### 步骤 4: 在浏览器中打开

访问 `http://localhost:3000` 查看插件界面。

> ⚠️ **注意**：在本地浏览器中，由于不在飞书环境中，会显示错误提示。这是正常的，需要在飞书文档中才能正常工作。

---

## 详细配置步骤

### 1. 在飞书开放平台创建应用

#### 1.1 注册开发者账号

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 使用飞书账号登录
3. 完成开发者认证（如需要）

#### 1.2 创建应用

1. 进入 [开发者后台](https://open.feishu.cn/app/)
2. 点击 **"创建企业自建应用"** 或 **"创建应用"**
3. 填写应用信息：
   - **应用名称**：文档筛选条件获取插件
   - **应用描述**：实时获取和监控飞书文档的筛选条件
   - **应用图标**：上传一个图标（可选）

#### 1.3 获取应用凭证

创建应用后，在应用详情页面可以找到：

- **App ID** (`app_id`): 例如 `cli_xxxxxxxxxxxxx` ✅ **只需要这个！**
- **App Secret** (`app_secret`): 例如 `xxxxxxxxxxxxxxxxxxxxx` ⚠️ **不需要**

> ✅ **重要说明**：
> - 这个插件是**客户端插件**，只需要 `App ID`
> - `App Secret` 用于服务端 API 调用，本项目不需要
> - 你只需要复制 `App ID` 即可

#### 1.4 配置应用权限

1. 在应用详情页面，找到 **"权限管理"** 或 **"Scopes"**
2. 申请以下权限：
   - `bitable:app` - 基础权限
   - `bitable:app:readonly` - 只读权限（必需）
   - `bitable:app:readwrite` - 读写权限（如果需要修改筛选条件）

3. 提交审核（企业自建应用通常立即生效）

### 2. 配置项目

#### 2.1 更新 manifest.json

打开 `manifest.json` 文件，替换以下内容：

```json
{
  "app_id": "你的_app_id",  // 替换为步骤 1.3 中获取的 App ID
  "app_name": "文档筛选条件获取插件",
  "app_version": "1.0.0",
  "app_type": "web",
  "description": "获取飞书文档的筛选条件",
  "icon": "https://your-icon-url.com/icon.png",  // 可选：你的图标 URL
  "scopes": [
    "bitable:app",
    "bitable:app:readonly",
    "bitable:app:readwrite"
  ],
  "api_version": "1.0.0"
}
```

#### 2.2 配置环境变量（可选）

如果需要使用环境变量，创建 `.env.local` 文件：

```bash
# .env.local
FEISHU_APP_ID=你的_app_id  # 只需要这个
NEXT_PUBLIC_PLUGIN_URL=http://localhost:3000
```

> ⚠️ **注意**：`FEISHU_APP_SECRET` 不需要，因为这是客户端插件

---

## 本地开发

### 开发模式

```bash
npm run dev
```

开发服务器支持：
- ✅ 热重载（修改代码自动刷新）
- ✅ 错误提示
- ✅ TypeScript 类型检查

### 访问地址

- **本地开发**: `http://localhost:3000`
- **局域网访问**: `http://你的IP:3000`（其他设备可访问）

### 代码结构

```
feishu-plugin/
├── app/                    # Next.js App Router 目录
│   ├── page.tsx           # 主页面
│   ├── layout.tsx         # 布局组件
│   └── globals.css        # 全局样式
├── components/            # React 组件
│   ├── FilterMonitor.tsx  # 核心功能组件
│   └── ui/                # UI 组件
├── types/                 # TypeScript 类型定义
├── manifest.json          # 飞书插件配置
└── package.json           # 项目配置
```

### 常用命令

```bash
# 开发模式
npm run dev

# 构建生产版本
npm run build

# 启动生产服务器（需要先 build）
npm start

# 代码检查
npm run lint
```

---

## 部署到生产环境

### 方式一：Vercel 部署（推荐）

1. **安装 Vercel CLI**（可选）：

```bash
npm i -g vercel
```

2. **部署**：

```bash
vercel
```

或者访问 [Vercel](https://vercel.com/) 网站，通过 GitHub 导入项目自动部署。

3. **配置环境变量**（可选）：

在 Vercel 项目设置中添加（如果需要）：
- `FEISHU_APP_ID` - 只需要这个

### 方式二：其他平台部署

#### 使用 Docker

创建 `Dockerfile`：

```dockerfile
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV production
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000
CMD ["node", "server.js"]
```

#### 使用传统服务器

1. **构建项目**：

```bash
npm run build
```

2. **启动生产服务器**：

```bash
npm start
```

3. **使用 PM2 管理进程**（推荐）：

```bash
npm install -g pm2
pm2 start npm --name "feishu-plugin" -- start
pm2 save
pm2 startup
```

### 配置 HTTPS

飞书插件要求使用 HTTPS，你需要：

1. 获取 SSL 证书（可以使用 Let's Encrypt 免费证书）
2. 配置反向代理（Nginx/Apache）
3. 确保域名解析正确

### 在飞书开放平台配置插件地址

1. 进入应用详情页面
2. 找到 **"网页应用"** 或 **"Web App"** 配置
3. 设置 **"应用主页 URL"** 为你的部署地址：
   ```
   https://your-domain.com
   ```
4. 保存配置

---

## 在飞书中使用

### 方法一：作为网页应用使用

1. **在飞书文档中插入插件**：
   - 打开飞书多维表格
   - 点击右上角 **"..."** 菜单
   - 选择 **"插入"** → **"网页"** 或 **"应用"**
   - 输入你的插件 URL

2. **授权应用**：
   - 首次使用时，飞书会要求授权
   - 点击 **"同意"** 授予权限

3. **使用插件**：
   - 插件会自动获取当前视图的筛选条件
   - 修改筛选条件后，插件会自动更新

### 方法二：作为自定义应用安装

1. **发布应用**（如果需要）：
   - 在飞书开放平台提交应用审核
   - 审核通过后，应用会出现在应用商店

2. **安装应用**：
   - 在飞书中搜索你的应用
   - 点击安装
   - 授权权限

3. **在文档中使用**：
   - 打开多维表格
   - 插入你的应用
   - 开始使用

---

## 故障排查

### 问题 1: 无法获取筛选条件

**症状**：界面显示错误提示

**解决方案**：
1. ✅ 确认在飞书文档环境中运行（不是普通浏览器）
2. ✅ 检查是否已授权应用权限
3. ✅ 确认当前视图有筛选条件
4. ✅ 查看浏览器控制台错误信息

### 问题 2: 事件监听不工作

**症状**：筛选条件变化后不自动更新

**解决方案**：
1. ✅ 打开浏览器控制台，查看是否有错误
2. ✅ 检查是否显示 "✅ 已成功订阅视图变化事件"
3. ✅ 手动点击"刷新"按钮测试
4. ✅ 轮询机制会每 3 秒检查一次，应该能捕获变化

### 问题 3: 构建失败

**症状**：`npm run build` 报错

**解决方案**：
1. ✅ 检查 Node.js 版本（需要 18+）
2. ✅ 删除 `node_modules` 和 `package-lock.json`，重新安装：
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```
3. ✅ 检查 TypeScript 错误：
   ```bash
   npm run lint
   ```

### 问题 4: 本地开发无法访问

**症状**：`npm run dev` 后无法打开页面

**解决方案**：
1. ✅ 检查端口 3000 是否被占用
2. ✅ 尝试使用其他端口：
   ```bash
   npm run dev -- -p 3001
   ```
3. ✅ 检查防火墙设置

### 问题 5: 部署后无法访问

**症状**：部署成功但无法在飞书中使用

**解决方案**：
1. ✅ 确认使用 HTTPS（飞书要求）
2. ✅ 检查域名是否正确配置
3. ✅ 确认在飞书开放平台配置了正确的应用主页 URL
4. ✅ 检查服务器日志查看错误信息

### 调试技巧

1. **查看控制台日志**：
   - 打开浏览器开发者工具（F12）
   - 查看 Console 标签
   - 查看 Network 标签（检查 API 请求）

2. **检查飞书 API**：
   ```javascript
   // 在浏览器控制台运行
   console.log(window.bitable)
   ```

3. **测试 API 调用**：
   ```javascript
   // 在浏览器控制台运行
   const base = await window.bitable.base.getActiveBase()
   console.log(base)
   ```

---

## 下一步

- 📖 阅读 [监听机制说明](./监听机制说明.md) 了解技术细节
- 🔧 查看 [API 文档](https://open.feishu.cn/document/) 了解更多功能
- 💡 根据需要修改和扩展插件功能

---

## 获取帮助

如果遇到问题：

1. 查看本文档的故障排查部分
2. 查看浏览器控制台的错误信息
3. 参考 [飞书开放平台文档](https://open.feishu.cn/document/)
4. 提交 Issue 到项目仓库

---

**祝你使用愉快！** 🎉


